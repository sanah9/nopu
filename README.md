# Nopu

## Project Overview

Nopu is a completely **free and open source** push service based on the Nostr protocol

- Built-in subscription management leveraging the **NIP-29 relay implementation**.
- Users can configure pushes to be delivered exclusively to their own clients, or deploy a **self-hosted** push server.
- The Nopu client can freely choose a private push server instead of the nopu.sh server.

## System Architecture

![System Architecture](digram.svg)

- **Subscription Server**  
  - Self-hostable  
  - Subscribes to relay events  
  - Receives client subscriptions
- **nopu Push Server**  
  - Receives messages from Subscription Server  
  - Forwards via FCM/APNs
- **nopu Clients (iOS / Android)**  
  - Display push messages  
  - Send subscriptions to Subscription Server

## Event Flow

1. The client creates a subscription by publishing a `kind 9007` event, which creates a NIP-29 private group. The event's `about` field uses the following format:

   ```
   ["REQ", <device_id>, <filters1>, <filters2>, ...]
   ```

2. The server listens to the configured relays and kinds (later this list will be minimized by intelligently merging the relay and kind sets derived from the filters). Once an event is received, it is matched against the filters of every registered group.

3. For every group whose filters match the event:

   - A `kind 20284` event is forwarded to the group.
   - If no members of the group are online, an APNS / FCM remote push notification is sent instead.

4. If the client needs to update its subscription filters, it publishes a `kind 9002` event containing the new filter set to refresh the existing subscription.

### Kind 20284 Event Format

The `kind 20284` event **wraps the original event as a JSON string** and targets a specific NIP-29 group.

```jsonc
{
  "kind": 20284,
  "content": "<stringified original event JSON>",
  "created_at": <unix_timestamp>,
  "tags": [
    ["h", "<group_id>"]
  ],
  "pubkey": "<relay_pubkey>",
  "id": "<event_id>",
  "sig": "<signature>"
}
```

Field explanations:

- `content`: The original Nostr event, serialized as a JSON string.
- `h tag`: Associates the wrapped event with the target subscription.
- `created_at`: Timestamp generated by the relay when forwarding.
- `pubkey`: The relay's public key used to sign the event.
- `sig`: Signature computed with the relay's private key.

## Quick Start

### 1. Environment Setup

```bash
# No external dependencies required!
# The system now uses in-memory queue instead of Redis
# This significantly reduces memory usage and simplifies deployment
```

### 2. Configuration

```bash
# Copy configuration file
cp config.yaml.example config.yaml
```

### 3. Start Service

```bash
# Install dependencies 
make deps

# Run both services
make run-both

# Or run services separately
make run-subscription  # Terminal 1
make run-push         # Terminal 2
```

### 4. Testing

```bash
# Run all tests
make test-all

# Run specific tests
make test-subscription  # Test subscription server
make test-push         # Test push server

# Run integration tests
make test-integration

# Run test client
make test-client

# For detailed testing guide, see TESTING.md
```

## Development Status

### Completed

- Relay / kinds events listening
- Basic subscription workflow
- Client online presence detection
- APNs push notifications

### In Progress

- Intelligent minimal filters merging
- FCM push notifications
- Performance optimization

